var isValidate=true;function initRadio(){$("li[typ='radio']","#fields").each(function(g,r){var e=$(r),n=e.find("div.content");if(e.has("fieldset").length>0){n=n.find("fieldset")}if(e.attr("random")=="1"){var d=[],k=n.children();if(k.length==0){k=n.find(">label")}var q=$(k[k.length-1]).find(":radio").hasClass("other"),m,f=k.length;if(q){m=k[k.length-1];f=k.length-1}while(d.length<f){var o=Math.random();o=Math.round(o*(f-1));if($.inArray(o,d)===-1){d.push(o)}}n.empty();for(j=0;j<f;j++){n.append(k[d[j]])}if(q){n.append(m)}}n.find(">label:eq(0)").addClass("first");var b=function(){var s=$(this).parent().parent(),l=$.trim($(this).val());if(!l){l="其它"}s.find(":radio.other").val(l)};n.find(":text.other").bind({keyup:b,change:b,click:function(c){$(this).parent().parent().find(":radio.other").prop("checked",true);highlight(c,this)}})});if(!window.isForMobile){var a=null;$(":radio").bind({click:function(b){if(a===this){$(a).prop("checked",false).trigger("change");a=null}else{a=this;if($(this).hasClass("other")){$(this).parent().find(":text.other").focus()}}b.stopPropagation()}});$("table.table td").click(function(){var b=$(this).find(":radio");b.attr("checked",true)})}}function initUpload(){var b=function(d){var k;if($("#_id").val()){var m=d.find("div.content"),l=m.find("input.fileSize").attr("name"),g=m.find("input.fileId").attr("name"),f=m.find("input.fileType").val(),e=[g.substring(0,l.indexOf("_")),m.find("input.fileType").attr("name"),l.substring(0,l.indexOf("_")),m.find("input.fileName").attr("name")];k={ENTRYID:$("#_id").val(),FRMID:$("#FRMID").val(),FILEID:m.find("input.fileId").val(),FILETYPE:f,FILEFIELDS:e,FLDID:d.attr("id")}}else{k={FRMID:$("#FRMID").val(),FLDID:d.attr("id")}}return k},a=function(d,e){var f=d.find("div.content");if(e.status==="success"){d.removeClass("error").find("p.errMsg").remove();f.find("div.uploadedFile").show();if($.isImage(e.fileName)){f.find("span.uploadedFileName").html($.format('<img class="img-edit" src="{0}" />',IMAGEURL+e.fileId+e.fileType+FILEIMAGEEDITSTYLE))}else{f.find("span.uploadedFileName").text($.format("{0}({1})",e.fileName,$.formatFileSize(e.fileSize)))}f.find("input.fileId").val(e.fileId).trigger("change");f.find("input.fileName").val(e.fileName).trigger("change");f.find("input.fileSize").val(e.fileSize).trigger("change");f.find("input.fileType").val(e.fileType).trigger("change")}else{if(e.status==="error"){showErrorMsg(d,$.format(msg[e.errCode],e.msg));f.find("input.fileId").val("").trigger("change");f.find("input.fileName").val("").trigger("change");f.find("input.fileSize").val("").trigger("change");f.find("input.fileType").val("").trigger("change")}}$("#btnSubmit").prop("disabled",false);$.hideStatus()};$("#fields").find("input.file").each(function(e,d){var g=$(d),c=g.parent().parent(),k;g.localResizeIMG({cprs:c.attr("cprs"),quality:0.5,before:function(l,f){k=$(l).val().match(/[^\/\\]*$/)[0];$.showStatus("正在上传文件...")},unsupport:function(){ajaxUpload(c)},success:function(f){var l=$.extend(b(c),{IMAGENAME:k,IMAGEDATA:f.clearBase64});if(l.FILEFIELDS){l.FILEFIELDS=l.FILEFIELDS.join(",")}jQuery.ajax({url:"/web/formview/compressandupload",data:l,type:"post",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(n,m){a(c,n);$.hideStatus()},error:function(n,m,o){showErrorMsg(c,$.format(msg.uploadError,o));isValidate=true;$("#btnSubmit").prop("disabled",false);$.hideStatus();return false}})}})});$("a.deleteIcon","#fields").live({click:function(){if(!$(this).parent().find("img").attr("src")){$(this).parent().remove()}else{if(confirm("删除后不可恢复，确认删除吗？")){var r=$(this).parents(".content"),q=$(this).parent(),g,m="/web/formview/deletefile";if($("#_id").val()){var s=r.find("input.fileSize").attr("name"),e=r.find("input.fileId").attr("name"),t=r.find("input.fileType").val(),k=[e.substring(0,s.indexOf("_")),r.find("input.fileType").attr("name"),s.substring(0,s.indexOf("_")),r.find("input.fileName").attr("name")];var n=$(this).parent().index();var l=$(this).parents("li").find(".fileName").val().split(",")[n];var f=$(this).parents("li").find(".fileId").val().split(",")[n];var o=l.split(".").length;g={ENTRYID:$("#_id").val(),FRMID:$("#FRMID").val(),FILEID:f,FILETYPE:"."+l.split(".")[o-1],FILEFIELDS:k,INITTIME:INITTIME};m="/web/entries/deletefile"}else{var n=$(q).index();g={FRMID:$("#FRMID").val(),FILEID:r.find("input.fileId").val().toString().split(",")[n],FILETYPE:r.find("input.fileType").val().toString().split(",")[n]}}$.showStatus("正在删除文件...");$.postJSON(m,g,function(D){if(D){$.alert(D.ERRMSG);$.hideStatus();return}var A=$(q).index();var d=r.find("input.fileId").val().toString().split(",");var x=r.find("input.fileName").val().toString().split(",");var u=r.find("input.fileSize").val().toString().split(",");var C=r.find("input.fileType").val().toString().split(",");d.splice(A,1);x.splice(A,1);u.splice(A,1);C.splice(A,1);q.remove();var B=r.find("input.fileId"),z=r.find("input.fileName"),v=r.find("input.fileSize"),c=r.find("input.fileType");B.val(d).trigger("change");z.val(x).trigger("change");v.val(u).trigger("change");c.val(C).trigger("change");if($("#_id").val()){var y={};y[B.attr("name").split("_")[0]]=d.join(",");y[z.attr("name").split("_")[0]]=x.join(",");y[v.attr("name").split("_")[0]]=u.join(",");y[c.attr("name").split("_")[0]]=C.join(",");$.postJSON("/web/formview/updateentry",{FRMID:$("#FRMID").val(),ENTRYID:$("#_id").val(),DATA:y},function(){})}$.hideStatus()})}}return false}})}var calShopCard=function(){var k=false,a,l,g,n,d,b,f=0,o=0,m=0;$("#fields>li[TYP='goods']").each(function(r,q){a=$(q);l=$("#ul"+a.attr("id")).empty();if(!a.is(":visible")){return true}a.find("div.goods-item").each(function(s,t){var u=$(t);d=parseFloat(u.find("input.number").val())||0;n=u.find("div.price").text();g=parseFloat(n.replace(/[¥$£€]/,""))||0;b=u.find("label.name").text();if(d>0){l.append($.format("<li><span class='goods-name'>{0}</span><span class='price-number'>{1} × {2}</span></li>",b,n,d));m+=d*g;k=true}})});m=m.toFixed(2);f=m;var c=parseFloat($("#shopping_cart").find("span.salem").text())||0,e=parseFloat($("#shopping_cart").find("span.salej").text())||0;if(c>0&&e>0){o=(Math.floor(m/c)*e).toFixed(2);f=(m-o).toFixed(2)}$("#amount").val(f);if(k){$("#shopping_cart").show().find("span.total").text(m).end().find("span.amount").text(f);if(o>0){$("#shopping_cart").find("div.discount-container").show().find("span.discount").text(o)}else{$("#shopping_cart").find("div.discount-container").hide()}}else{$("#shopping_cart").hide()}};function initGoods(){$("#fields div.goods-item a.decrease,#fields div.goods-item a.increase").click(function(){var d=$(this).parent(),b=d.find("input.number"),a=parseFloat(b.val())||0;if(b.prop("disabled")){return false}if($(this).hasClass("decrease")){if(a>=1){b.val(--a)}}else{b.val(++a)}calShopCard();return false});$("#fields div.goods-item").find("input.number").bind({blur:function(){calShopCard()}});$("#fields div.goods-item").find("input.number").trigger("blur")}function initAuthCode(){var a=function(b,d){d.click(function(){var g=$(this).attr("tmpidx"),f=$("#btnSendCode"+g),k=b.getValidate();if(!k){$.alert("请先完成验证。");return false}if(f.hasClass("disabled")){return false}var e=$("div.content").has(f).find("input.phone").val();if(!$.isMobile(e)){$.alert("请输入正确的手机号码。");return false}$.ajax({url:"/web/VerifyLoginServlet",type:"post",dataType:"json",data:{geetest_challenge:k.geetest_challenge,geetest_validate:k.geetest_validate,geetest_seccode:k.geetest_seccode,TEL:e,TYP:"form",FRMID:$("#FRMID").val(),SIGN:f.attr("SIGN")},success:function(n){if(n&&(n.status==="success")){var m=f.attr("tmpidx"),o=$("#btnSendCode"+m);o.text("120").prop("disabled",true).addClass("disabled");var l=setInterval(function(){var q=parseInt(o.text());if(q>0){o.text(--q)}else{o.text("发送验证码").prop("disabled",false);o.removeClass("disabled");clearInterval(l)}},1000);if(n.sendcount<=0){clearInterval(l);o.text("发送验证码").prop("disabled",false).removeClass("disabled");$.alert("发送验证码失败：可用短信量不足，需要充值，请与表单创建者联系。")}return false}else{$.alert("验证失败")}}});return false});var c=d.attr("tmpIdx");b.bindOn("#btnSendCode"+c);b.appendTo("#popupCaptcha"+c)};if($("#fields").find("button.sendcode").length>0){$("#fields").find("button.sendcode").each(function(c,b){$.ajax({url:"/web/StartCaptchaServlet",type:"get",dataType:"json",success:function(d){initGeetest({gt:d.gt,challenge:d.challenge,product:"popup",offline:!d.success},function(e){a(e,$(b))})}})})}}function initInstruct(){var a=$("#fields>li");$.each(a,function(c,b){p=$(b).find("p.instruct").removeClass("hide");$(b).find("div.content").prepend(p)})}function initAddress(){$("#fields>li[typ='address']").each(function(d,b){b=$(b);var f=b.attr("def"),a,g=b.find("select.province"),k=b.find("select.city"),e=b.find("select.zip"),c="";if(f){a=f.split("-")}$.each(address.provinces,function(m,l){c+=$.format("<option value='{0}'>{1}</option>",m,m)});g.append(c);g.change(function(){var l=$(this).val();k.empty().append("<option value=''>市</option>");e.empty().append("<option value=''>区/县</option>");if(l){var m="";$.each(address.provinces[l],function(o,n){m+=$.format('<option value="{0}">{1}</option>',o,o)});k.append(m)}});k.change(function(){var l=b.find("select.province").val(),n=$(this).val();e.empty().append("<option value=''>区/县</option>");if(n){var m="";$.each(address.provinces[l][n],function(q,o){m+=$.format('<option value="{0}">{1}</option>',o,o)});e.append(m)}});if(a&&a[0]){g.val(a[0]);g.trigger("change")}if(a&&a[1]){k.val(a[1]);k.trigger("change")}if(a&&a[2]){e.val(a[2])}})}function initMap(){$("#fields").find("div.map").each(function(e,r){var o=$(r).parent(),f=o.find("input.location"),d=o.find("input.j"),q=o.find("input.w"),l=o.find("button.getlocation,button.getlocation1"),s=o.find("button.marker");var b,n,m;var a=function(u){d.val(u.position.getLng());q.val(u.position.getLat());var t=new AMap.LngLat(u.position.getLng(),u.position.getLat());b.clearMap();var c=new AMap.Marker({});c.setPosition(t);c.setMap(b);b.setCenter(t);m.getAddress(t)},k=function(){$.alert("获取地址位置失败，请检查GPS是否打开，然后重试一次。");$.hideStatus()},g=function(c){f.val(c.regeocode.formattedAddress);f.removeClass("hide").show();f.trigger("change");l.text("重新获取").parent();$.hideStatus()};var b=new AMap.Map($(r).attr("id"),{zoom:13});b.plugin(["AMap.Geolocation","AMap.Geocoder"],function(){n=new AMap.Geolocation({});m=new AMap.Geocoder({radius:1000,extensions:"all"});b.addControl(n);AMap.event.addListener(n,"complete",a);AMap.event.addListener(n,"error",k);AMap.event.addListener(m,"complete",g)});$(r).data("map",b);AMap.event.addListener(b,"click",function(u){b.clearMap();var c=new AMap.Marker({});d.val(u.lnglat.getLng());q.val(u.lnglat.getLat());var t=new AMap.LngLat(u.lnglat.getLng(),u.lnglat.getLat());c.setPosition(t);c.setMap(b);m.getAddress(t)});l.click(function(){$.showStatus();n.getCurrentPosition()});s.click(function(){var c=o.find("div.map");if(!c.hasClass("hide")){c.addClass("hide")}else{c.removeClass("hide")}o.find("input.location").show();return false});f.change(function(){if(!$(this).val()){d.val("");q.val("")}})})}function highlight(d,b){var a=$("li").has(b),c=a.attr("typ");$("li.focused").removeClass("focused");if(!a.hasClass("error")){a.addClass("focused")}$("p.instruct").addClass("hide");a.find("p.instruct").removeClass("hide");d.stopPropagation()}function initYzjMenu(){var b=$("#formHeader h2").text();if($.isYzjApp()&&!window.ISMBLEDIT){XuntongJSBridge.call("setWebViewTitle",{title:b});var a=[{text:"我的表单",callBackId:"myFormButton"},{text:"我的报表",callBackId:"myReportButton"},{text:"创建表单",callBackId:"newFormButton"},{text:"我的账户",callBackId:"myAccountButton"}];XuntongJSBridge.call("createPop",{popTitle:"...",popTitleCallBackId:"",items:a,menuList:["forward","refresh","openWithBrowser"],shareData:{isShowExt:true,title:b,description:"帮您玩转企业数据，提高营销效率、降低管理成本",appName:"表单大师"}},function(c){if(c.success==true||c.success=="true"){var d=c.data?c.data.callBackId:"";if(d=="newFormButton"){window.location.href="/app/formbuilderm1.jsp"}else{if(d=="myAccountButton"){window.location.href="/app/account/manage"}else{if(d){window.location.href="/app/form/manage"}}}}})}}function initFocus(){if(window.isForMobile){$("#fields").find(".controlgroup>label,table.table label").bind({click:function(a){a.stopPropagation()}});$("[typ='file']").click(function(){if(!$(this).hasClass("focused")){$("li.focused").removeClass("focused");$("p.instruct").addClass("hide");var a=$(this).attr("typ");if(a!="section"&&a!="html"&&a!="image"&&a!="goods"){$(this).addClass("focused").find("p.instruct").removeClass("hide").end().find(":input:eq(0)").focus()}}});return}$(".fld").bind({click:function(a){highlight(a,this)},focus:function(a){highlight(a,this)}});$("#fields>li[id]").click(function(){if(!$(this).hasClass("focused")){$("li.focused").removeClass("focused");$("p.instruct").addClass("hide");var a=$(this).attr("typ");if(a!="section"&&a!="html"&&a!="image"&&a!="goods"){$(this).addClass("focused").find("p.instruct").removeClass("hide").end().find(":input:eq(0)").focus()}}})}function updateSelects(a,b){var d=$(b).is("li")?$(b):$(b).parent().parent();if(a&&d.find("input.yyyy").length>0){d.find("input.yyyy").val(a.getFullYear());d.find("input.mm").val($.formatHH(a.getMonth()+1));d.find("input.dd").val($.formatHH(a.getDate()));d.find("input.val").val($.getDate(d)).trigger("change")}else{d.find("input.val").val(a).trigger("change")}}function initNumberInput(){var e=function(m){var l=m.find("input.tel1").val(),k=m.find("input.tel2").val(),g=m.find("input.tel3").val();if(l||k){return $.format("{0}-{1}-{2}",l,k,g)}else{return""}},f=function(k){var g=$(this).val(),l=$(this).parent().parent();$(this).val(g.replace(/^\+\D/g,""));l.find(".val").val(e(l))},b=function(k){var g=$(this).val(),l=$(this).parent().parent();$(this).val(g.replace(/\D/g,""));l.find(".val").val($.getTime(l)).trigger("change")},d=function(k){var g=$(this).val(),l=$(this).parent().parent();$(this).val(g.replace(/\D/g,""));l.find(".val").val($.getDate(l)).trigger("change")},c=function(k){if(window.isForMobile){return}var g=$(this).val();$(this).val(g.replace(/[^(\-?\d\.?)]/g,"").replace(/[\(\)\?]/g,""))},a=function(){var g=$(this).val(),k=$(this).parent().parent();$(this).val(g.replace(/-/g,""));k.find(".val").val($.getName(k)).trigger("change")};$("select.hh,select.mi","#fields").live({change:function(){var l=$(this).parent().parent(),k=l.find("select.hh").val(),g=l.find("select.mi").val();if(k&&g){l.find(".val").val($.format("{0}:{1}",k,g))}else{l.find(".val").val("")}}});$("input.yyyy,input.mm,input.dd","#fields").bind({keyup:d,change:d});$("input.number,input.money","#fields").bind({keyup:c,change:c});$("input.n1,input.n2,input.n3","#fields").bind({keyup:a,change:a});$("input.authcode,input.phone,input.tel1,input.tel2,input.tel3","#fields").bind({keyup:f,change:f})}function initDropdown2(){var a=5;for(var b=1;b<a;b++){$("#fields").find("select.dd"+b).bind({change:function(){var e=$(this).find("option:selected").attr("items");var f=[];if(e){f=JSON.parse(e)}else{f.push({VAL:""})}var d=parseInt($(this).attr("level"));var c=$(this).parent().find("select.dd"+(d+1));c.empty();$.each(f,function(g,k){if(k.ITMS){c.append($.format("<option items='{0}' value='{1}'>{1}</option>",JSON.stringify(k.ITMS),k.VAL))}else{c.append($.format("<option value='{0}'>{0}</option>",k.VAL))}});c.trigger("change")}}).trigger("change")}}FieldRelation={fillAutoCompValue:function(a){var c=a.val(),b=a.attr("matfrm"),e=a.attr("matfld"),d=a.data("liids");if(c&&b&&e){$.postJSON("/web/formview/getmatchvalue",{FRMID:b,FLD:e,VAL:c,EXFLDS:"",FLDS:a.data("matflds"),EXMAT:"1"},function(f){if(f.length>0){FieldRelation.setAutoCompValue(d,f[0])}})}},getMatchedText:function(b){var a=b.indexOf(",");if(a>0){return b.substring(0,a)}else{return b}},updown:function(f,e){var c=$(f),d=c.parent().find("ul.matul"),b=d.find("li").length,l=d.find("li.selected"),k=l.index(),g=c.data("oldval");if(e==40){if(k<b-1){l.removeClass("selected");var a=d.find("li:eq("+(k+1)+")");a.addClass("selected");c.val(a.text())}else{l.removeClass("selected");c.val(g)}}else{if(e==38){if(k>0){l.removeClass("selected");var a=d.find("li:eq("+(k-1)+")");a.addClass("selected");c.val(a.text())}else{if(k==0){l.removeClass("selected");c.val(g)}else{var a=d.find("li:eq("+(b-1)+")");a.addClass("selected");c.val(a.text())}}}}},getmatchdata:function(k,d){var f=d.which;if(f==40||f==38||f==13){FieldRelation.updown(k,f);return false}var a=$(k),m=a.val(),b=a.attr("matfrm"),n=a.attr("matfld"),l=a.attr("exmat");p=a.position(),h=a.outerHeight(),w=a.innerWidth();var c=a.parent().find("ul.matul"),g=$("#fields>li").has(a).attr("ex");a.data("oldval",m);if(m){$.postJSON("/web/formview/getmatchvalue",{FRMID:b,FLD:n,VAL:m,EXFLDS:g?JSON.parse(g).matfld:"",FLDS:a.data("matflds"),EXMAT:l},function(e){if(c.length==0){c=$("<ul class='matul'></ul>");a.after(c)}c.css("top",p.top+h);c.css("left",p.left);c.css("minWidth",w);c.empty().show();$.each(e,function(s,q){var t=new RegExp("("+a.data("oldval")+")","g");var u="<li>"+q[n].replace(t,"<i>$1</i>");if(g){var r=JSON.parse(g).matfld.split(",");$.each(r,function(v,x){if(x&&q[x]){u+=","+q[x]}})}u+="</li>";var o=$(u);o.data("data",q);c.append(o);o.bind({mouseover:function(){$(this).addClass("selected")},mouseout:function(){if($(this).is(":visible")){$(this).removeClass("selected")}},mousedown:function(){var x=$(this).parent(),v=x.parent().find("input.fld");FieldRelation.setAutoCompValue(v.data("liids"),$(this).data("data"));v.val(FieldRelation.getMatchedText($(this).text()));$(this).addClass("selected");x.hide()}})})})}else{c.hide()}},setAutoCompValue:function(c,b){var a=function(d,f){var l=d.find("select.province"),m=d.find("select.city"),e=d.find("select.zip"),k=d.find("textarea.detail"),g=d.attr("acmpfld").split(",");l.val("");m.val("");e.val("");k.val("");if(f[g[0]]){l.val(f[g[0]]).trigger("change")}if(f[g[1]]){m.val(f[g[1]]).trigger("change")}if(f[g[2]]){e.val(f[g[2]])}if(f[g[3]]){k.val(f[g[3]])}};$.each(c,function(k,q){if(!q){return true}var s=$("#"+q),n=s.attr("acmpfld"),o=s.attr("typ"),e=s.attr("fmt"),r=b[n];if(o!="radio"&&o!="checkbox"){s.find("input").val("");s.find("input[name]").val(r||"")}var f=":text";if(o=="date"){$.setDate(s,r)}else{if(o==="time"){$.setTime(s,r);f="input"}else{if(o==="name"){$.setName(s,r)}else{if(o==="phone"){$.setPhone(s,r)}else{if(o=="dropdown"){s.find("select[name]").val("");s.find("select[name]").val(r||"");f="select"}else{if(o=="radio"){s.find("input[name]").prop("checked",false);s.find("input[value='"+r+"']").trigger("click");if(s.find("input:radio[value='"+r+"']").length==0&&s.find("input:radio.other").length!=0){s.find("input:radio.other").prop("checked",true);s.find("input.other[type='text']").val(r)}f=":radio"}else{if(o=="address"){a(s,b);f="select"}else{if(o=="name"){$.setName(s,r)}else{if(o=="image"){var m=n.split(","),d=b[m[0]],l=b[m[1]],g="";if(d&&l){g=d.split(",")[0]+l.split(",")[0]}if($.isImage(g)){s.find(".image-img").attr("src",IMAGEURL+g)}else{s.find(".image-img").attr("src","/rs/images/defaultimg.png")}}else{if(o=="textarea"){s.find("textarea[name]").val("");s.find("textarea[name]").val(r||"")}}}}}}}}}}if(f==":checkbox"){s.find(f).trigger("click")}else{s.find(f).trigger("change")}if(o=="date"){s.find("input.val").val(r)}if(o=="address"){a(s,b)}})}};function initMatchAndAcmp(){$("#fields").find("input[matfrm],select[matfrm]").each(function(i,_txt){var txt=$(_txt),ex=$("#fields>li").has(txt).attr("ex"),nm=txt.attr("name"),matfld=txt.attr("matfld"),fields=[matfld],liids=[];if(ex){var obj=JSON.parse(ex);if(obj.matfld){var matflds=obj.matfld.split(",");$.each(matflds,function(i,v){fields.push(v);liids.push(null)})}}$("#fields>li[acmpsrcfld]").each(function(j,li){var l=$(li),acmpsrcfld=l.attr("acmpsrcfld"),acmpfld=l.attr("acmpfld");if((nm==acmpsrcfld||nm.indexOf(acmpsrcfld+"_")>-1)&&acmpfld){fields.push(acmpfld);liids.push(l.attr("id"))}});if(txt.is("select")){txt.bind({change:function(){var acmpData=eval("("+$(this).find("option:selected").attr("acmp")+")");FieldRelation.setAutoCompValue(liids,acmpData)}})}else{txt.data("matflds",fields);txt.data("liids",liids);var keyupTime;var str="",now="",filter_time=function(e){var time=setInterval(function(){filter_staff_from_exist(e)},500);txt.bind("blur",function(){clearInterval(time)})},filter_staff_from_exist=function(e){now=$.trim(txt.val());if(now!=str){FieldRelation.getmatchdata(txt,e)}str=now};txt.bind({focus:function(e){str=$.trim(txt.val());filter_time(e)},keyup:function(e){keyupTime=new Date().getTime(),_this=$(this);var keycode=e.which;if(keycode==40||keycode==38){FieldRelation.getmatchdata(_this,e);now=$.trim(txt.val());str=now;return false}},keypress:function(e){var keycode=e.which;if(keycode==13){var txt=$(_txt),ul=txt.parent().find("ul.matul"),li=ul.find("li.selected"),idx=li.index(),oldVal=txt.data("oldval");if(idx>=0){txt.val(FieldRelation.getMatchedText(txt.val()));FieldRelation.setAutoCompValue(txt.data("liids"),li.data("data"))}ul.hide();return false}},blur:function(){var txt=$(_txt),ul=txt.parent().find("ul.matul"),li=ul.find("li.selected"),idx=li.index();if(idx>=0){FieldRelation.setAutoCompValue(txt.data("liids"),li.data("data"))}else{}ul.hide()}})}})}function initFieldsPermForView(){if(window.ADVPERM&&"1"==ADVPERM.VIEWPERM){$("#fields").find("li").each(function(c,b){var a=$(b);if("1"==ADVPERM.VIEWPERM&&$.inArray(a.attr("id"),ADVPERM.VIEWFLDS)==-1){var d=a.attr("typ")||"";if($.inArray(d,["image","html","section",""])==-1){a.addClass("hide")}}})}}function showErrorMsg(a,b){isValidate=false;a.addClass("error");if(a.find("p.errMsg").length===0){a.append("<p class='errMsg'></p>")}a.find("p.errMsg").text(b);$("#btnSubmit,#btnSave,#btnActSave").prop("disabled",false);$.hideStatus()}function initValidate(){var b=function(){var l=$("li").has(this),k=parseInt(l.attr("max")),g=$(this).val().length;if(l.find("span.lengthLimit").length===0){l.find("label.desc").append("<span class='lengthLimit'></span>")}if(k-g>=0){l.find("span.lengthLimit").text($.format(msg.lengthLimit,k-g))}else{$(this).val($(this).val().substring(0,k));l.find("span.lengthLimit").text($.format(msg.lengthLimit,0))}},d=function(){isValidate=true;var g=$("#fields").find("li[id]:visible"),k=true,u,n,A,C,o,y,x,G,t,r;for(i=0;i<g.length;i++){u=$(g[i]);r=true;n=u.attr("TYP"),A=u.attr("MIN"),C=u.attr("MAX"),o=u.attr("REQD"),y=u.attr("UNIQ"),x=u.attr("DEF"),G=u.attr("name"),t;if(o==="1"){var D=true;if(n==="radio"){var z=u.find(":checked");if((z.val()&&!z.hasClass("other"))||(z.hasClass("other")&&$.trim(u.find(":text").val()))){D=false}}else{if(n==="checkbox"||n==="likert"){if(u.find(":checked").length>0){D=false}}else{if(n==="goods"){u.find("div.goods-item input.number").each(function(H,v){if((parseFloat($(v).val())||0)>0){D=false;return false}})}else{if(n==="address"){var l=u.find("select.province").val(),B=u.find("select.city").val(),E=u.find("select.zip").val();if(l&&B&&E){D=false}}else{u.find(":input[name]").each(function(v,H){if($.trim($(H).val())){D=false;return}})}}}}if(D){k=false;r=false;showErrorMsg(u,msg.reqdError);continue}}if(A){t=u.find("input,textarea").val();if(t){if(n==="number"||n==="money"){if(parseFloat(t)<parseFloat(A)){k=false;r=false;showErrorMsg(u,$.format(msg.minNumberError,A));continue}}}if(n==="text"||n==="textarea"){if(t.length<parseFloat(A)){k=false;r=false;showErrorMsg(u,$.format(msg.minTextError,A));continue}}else{if(n=="checkbox"){if(u.find(":checkbox:checked").length<parseFloat(A)){k=false;r=false;showErrorMsg(u,$.format(msg.minChkError,A));continue}}}}if(C){t=u.find("input,textarea").val();if(t){if(n==="number"||n==="money"){if(parseFloat(t)>parseFloat(C)){k=false;r=false;showErrorMsg(u,$.format(msg.maxNumberError,C));continue}}}if(n==="text"||n==="textarea"){if(t.length>parseFloat(C)){k=false;r=false;showErrorMsg(u,$.format(msg.maxTextError,C));continue}}else{if(n=="checkbox"){if(u.find(":checkbox:checked").length>parseFloat(C)){k=false;r=false;showErrorMsg(u,$.format(msg.maxChkError,C));continue}}}}if(n==="number"||n==="money"){t=u.find(":input[name]").val();if(t!=""&&!$.isNumber(t)){k=false;r=false;showErrorMsg(u,msg.numberError);continue}}else{if(n==="date"){t=u.find(":input[name]").val();if(t!=""&&!$.isDate(t)){k=false;r=false;showErrorMsg(u,msg.dateError);continue}}else{if(n==="email"){t=u.find(":input[name]").val();if(t!=""&&!$.isEmail(t)){k=false;r=false;showErrorMsg(u,msg.emailError);continue}}else{if(n==="phone"){var s=u.find(":input[name]"),m=s.attr("fmt"),t=s.val();if(t&&m=="mobile"&&!$.isMobile(t)){k=false;r=false;showErrorMsg(u,msg.mobileError);continue}}else{if(n==="table"){var q=u.find("td[typ='email']");if(q&&q.length>0){$.each(q,function(H,v){var J=$(v);var I=J.find("input").val();if(I&&!$.isEmail(I)){k=false;r=false;showErrorMsg(J,msg.emailError)}})}}}}}}if(r){u.removeClass("error");u.find("p.errMsg").remove()}}return k},c=function(r){var g=$("li").has(r),l=g.find(":input[name]"),m=l.attr("name"),k=l.val(),o=false;var q={FRMID:$("#FRMID").val(),SID:$("#SID").val(),ENTRYID:$("#_id").val(),NM:m,VAL:k};$.postJSON("/web/formview/existValidate",q,function(n){o=!n;if(!o){showErrorMsg(g,msg.uniqError)}},{async:false});return o},f=function(m){var g=$("li").has(m),k=true;var l={kaptcha:g.find(":input[name='kaptcha']").val()};$.postJSON("/web/formview/captchaValidate",l,function(n){k=n;if(!k){showErrorMsg(g,msg.captchaError)}},{async:false});return k},a=function(g){var k=$("#"+g.attr("id").substring(2)),l=true;var m={TEL:k.find("input.phone").val(),CODE:g.find("input.authcode").val()};$.postJSON("/web/formview/authcodevalidate",m,function(n){l=n;if(!l){showErrorMsg(g,msg.authCodeError)}},{async:false});return l},e=function(){var g=true;$.postJSON("/web/formview/checklimit",$("#form1").getValues(),function(k){if(k&&k.length>0){$.hideStatus();$.each(k,function(m,l){if("goods"==l.TYP){g=false;showErrorMsg($("[name='"+l.NM+"_"+l.TYP+"']","#fields").parents("div.goods-item"),$.format("{0}限购数量为{1},还可以购买{2}{3},你已超出限购数量,需修改。",l.VAL,l.AMOUNTLMT,l.BALANCE,l.UNT))}else{g=false;showErrorMsg($("[name='"+l.NM+"_"+l.TYP+"']","#fields").parents("li"),$.format("{0}限制提交数量为{1},还可以提交{2}次,你已超出提交限制,需修改。",l.VAL,l.AMOUNTLMT,l.BALANCE))}});return false}},{async:false});return g};$("li[max]:has(textarea)","#fields").find("textarea").bind({keyup:b,change:b});$("#btnSubmit,#btnSave,#btnActSave").bind({click:function(){if($(this).hasClass("disabled")||$(this).prop("disabled")){return false}var k=$("#_id").val()?"edit":"new";if(k=="new"&&"1"==ADVPERM.ADV&&!"1"==ADVPERM.ADD){$.alert("没有新增数据的权限，请与管理员联系。");return false}$.each(RULE.FIELDSRULE||[],function(s,t){$.each(t.RULEFLD||[],function(u,v){if(!$("#"+v).is(":visible")){$("#"+v+",#au"+v).setValues({},true)}})});calShopCard();if(!d()){$("#fields").find("li.error:first").find(":input").focus();return false}$(this).prop("disabled",true);$.showStatus("正在验证数据...");if($("#liCaptcha").length>0){isValidate=f($("#liCaptcha").find(":text"))}if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}var o=$("li[uniq='1']");if(o.length>0){o.each(function(t,s){isValidate=c($(s).find(":input[name]"));if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}})}if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}$("#fields input.authcode").each(function(s,t){var u=$(t);isValidate=a($(u).parent().parent());if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}});if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}var n=$("li[ctlmt='DAY'], li[ctlmt='ALL']");if(n.length>0){isValidate=e();if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}}if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();$("#btnSubmit,#btnSave,#btnActSave").prop("disabled",false);$.hideStatus();return false}else{var k=$("#_id").val()?"edit":"new";if(k==="new"){var r=parseFloat($("#TMOUT").val());$("#TMOUT").val(Math.round((new Date().getTime()-r)/1000))}var g=$("#form1").find("li[typ!=table]").getValues();var m=$("#form1>input").getValues();$.mergJSON(g,m);$.each($("#form1>input[type='hidden']"),function(u,t){var s=$(t).attr("name");var v=$(t).val();g[s]=v});var q=$("#fields li[typ=table]");$.each(q,function(u,v){var t=$(v).find("div.tbl").attr("name");g[t]=[];var s=$(v).find("div.tbl tr:gt(0)");$.each(s,function(x,y){var z=$(y).getValues();g[t].push(z)})});$.each(g,function(t,s){if(/^t\d/.test(t)){delete g[t]}});if($(this).attr("id")==="btnSubmit"){if($("#FRMID").attr("autofill")=="1"){localStorage.setItem($("#FRMID").val(),JSON.stringify(g))}else{localStorage.removeItem($("#FRMID").val())}$.hideStatus();var l="/web/formview/"+$("#FRMID").val();$.postJSON(l,g,function(s){var t=s&&s.url;if(!t){t="/web/viewresult"}window.location.href=t})}else{$.showStatus("正在保存数据...");g.INITTIME=$.trim(INITTIME.toString());g.FRMNM=FRM.FRMNM;$.postJSON("/web/entries/save",g,function(s){if(s&&s.ERRMSG){alert(s.ERRMSG);$.hideStatus();return}$.closeLightBox();if(window.query){if(k==="new"){query(null,"FIRST",PAGESIZE,$("#entriesGrid").datagrid("getSortString"),$("#entriesGrid"))}else{if("1"==ADVPERM.ADV&&"1"==ADVPERM.FLT){query(null,"FIRST",PAGESIZE,$("#entriesGrid").datagrid("getSortString"),$("#entriesGrid"))}else{var t=$("#entriesGrid"),x=t.data("rowsData"),v=t.data("total"),u=t.find("tbody>tr.rowSelected").index();if(s.REALNAME&&s.REALNAME!=s.CBY){s.CBY=$.format("{0}({1})",s.CBY,s.REALNAME)}x[u]=s;t.data("rowsData",x);t.datagrid("fillData",{total:v,rows:x});t.find("tbody>tr:eq("+u+")").addClass("rowSelected");$("a.view").click(function(){setTimeout(function(){$("#btnActView").trigger("click")},150)});$("a.edit").click(function(){setTimeout(function(){$("#btnActEdit").trigger("click")},150)});window.selectedData=s;$("#btnActVie").trigger("click")}}$.hideStatus()}else{if(!window.isForMobile){alert("保存成功")}else{$.malert("保存成功，正在跳转...",function(){window.location.href=document.referrer+$.format("#l{0}",liIndex||0)})}$.hideStatus()}$("#btnSubmit,#btnSave,#btnActSave").prop("disabled",false)});return false}}return false}})}var getDateByReg=function(d){var f,b=/^\+?(-?\d+) ?[Dd]ays$/,e=/^\+?(-?\d+) ?[Ww]eeks$/,c=/^\+?(-?\d+) ?[Mm]onths$/,a=new Date();if(d==="today"){return a}else{if(b.test(d)){f=parseInt(d.replace(b,"$1"));return a.addDate("d",f)}else{if(e.test(d)){f=parseInt(d.replace(e,"$1"));return a.addDate("w",f)}else{if(c.test(d)){f=parseInt(d.replace(c,"$1"));return a.addDate("m",f)}else{if($.isDate(d)){return Date.fromString(d)}}}}}},getTimeByReg=function(d){var e,b=/^\+?(-?\d+) ?[Mm]inutes$/,c=/^\+?(-?\d+) ?[Hh]ours$/,a=new Date();if(d==="now"){return $.format("{0}:{1}",$.formatHH(a.getHours()),$.formatHH(a.getMinutes()))}else{if(b.test(d)){e=parseInt(d.replace(b,"$1"));a=a.addDate("n",e);return $.format("{0}:{1}",$.formatHH(a.getHours()),$.formatHH(a.getMinutes()))}else{if(c.test(d)){e=parseInt(d.replace(c,"$1"));a=a.addDate("h",e);return $.format("{0}:{1}",$.formatHH(a.getHours()),$.formatHH(a.getMinutes()))}else{if($.isTime(d)){return d}}}}};function setSubTblValue(a,c){a.find("div.tbl tr").filter(function(d){return d>=2}).remove();var b=0;if(c&&c.length>0){$.each(c,function(e,d){var g=a.find("div.tbl tr:last-child");if(b>0){var k=$(g).clone();$.each($(k).find("td"),function(m,n){if($(n).attr("typ")=="radio"){var l=$(n).find("input[type=radio]");$.each(l,function(s,o){var r=$(o).attr("name");var q=r.split("_");r=q[0]+"_"+q[1]+"_"+e;$(o).attr("name",r)})}});$(k).setValues(d,true);$(g).after(k)}else{$(g).setValues(d,true)}g=a.find("div.tbl tr:last-child");var f=$(g).find("td");$.each(f,function(l,m){if($(m).attr("typ")=="date"){$.setDate($(m),$(m).find("input.val").val())}else{if($(m).attr("typ")=="time"){$.setTime($(m),$(m).find("input.val").val())}}});b++})}}function setDefaultValue(b){if(window.ISMBLEDIT){return}if(b){$("#fields").setValues({},true);$("#fields").find("select.dd1").trigger("change")}else{var k=localStorage.getItem($("#FRMID").val());if(k&&$("#FRMID").attr("autofill")=="1"){try{var f=JSON.parse(k);$("#fields").setValues(f,true);var c=$("#fields").find("li[TYP='table']");if(c&&c.length>0){var a=$(c[0]).find("div.tbl").attr("name");var d=f[a];setSubTblValue($(c[0]),d)}setTimeout(function(){var e=false;$("#fields").find("li").each(function(o,n){if(e){return false}var m=$(n),q=m.attr("typ");if(q=="goods"){m.find("div.number-container").each(function(s,t){if(e){return false}var r=$(t),l=r.find("input.number");if(f[l.attr("name")]){e=true;return false}})}});if(e){calShopCard()}},0);$.each($("#fields").find("input[type=hidden],input.location"),function(n,m){var l=$(m).attr("name");if(l&&l.indexOf("time")>0){var o=$(m).val();var q=$(m).parent().parent();$.setTime(q,o)}else{if(l&&l.indexOf("date")>0){var e=$(m).val();var q=$(m).parent().parent();$.setDate(q,e)}else{$(m).val("")}}});$("#fields").find("li[typ='goods']").find("input.number").trigger("blur")}catch(g){}}}if(window.QPARAMS){$("#fields").setValues(window.QPARAMS,true,true);$.each(window.QPARAMS,function(m,l){var e=$(":text[name='"+m+"']");if(e.length>0&&e.attr("matfrm")&&e.attr("matfld")){FieldRelation.fillAutoCompValue(e)}})}$("li[def]","#fields").each(function(m,l){l=$(l);var r,o=l.attr("typ"),q=l.attr("def");if(!q){return}if(o==="date"){updateSelects(getDateByReg(q),l)}else{if(o==="time"){$.setTime(l,getTimeByReg(q))}else{if(o==="phone"){var e=q.split("-");if(e.length>0){$(e).each(function(s,n){l.find(":text:eq("+s+")").val(n)})}l.find(":input[name]").val(q)}else{if(o==="radio"){l.find(":radio:eq("+q+")'").prop("checked",true)}else{if(o==="dropdown"){}else{if(o==="likert"){l.find("tbody>tr").each(function(n,s){$(s).find(":radio:eq("+q+")'").prop("checked",true)})}else{l.find("input.fld,textarea.fld").val(q)}}}}}}})}function initRule(){var validateConditions=function(andor,cons){var validate=true;if(andor==="or"){validate=false}$.each(cons,function(i,con){var pass=true,input=$(":input[name='"+con.FLD+"']"),value;if(input.length===0){input=$(":input[name^='"+con.FLD+"_']")}value=input.val();if(input.is(":checkbox")||input.is(":radio")){value=undefined;input.each(function(i,p){if($(p).prop("checked")){value=$(p).val();return false}})}if(con.CTYP==="eq"){if(con.DTYP==="filesize"){pass=parseInt(value)===parseFloat(con.VAL)*1024*1024}else{if(con.DTYP==="number"){pass=parseFloat(value)===parseFloat(con.VAL)}else{if(con.DTYP==="date"){pass=value===$.formatDate(getDateByReg(con.VAL))}else{pass=value===con.VAL}}}}else{if(con.CTYP==="ne"){if(con.DTYP==="filesize"){pass=parseInt(value)!=parseFloat(con.VAL)*1024*1024}else{if(con.DTYP==="number"){pass=parseFloat(value)!=parseFloat(con.VAL)}else{pass=value!=con.VAL}}}else{if(con.CTYP==="bw"){pass=value.indexOf(con.VAL)===0}else{if(con.CTYP==="ew"){var reg=new RegExp("("+con.VAL+")$","gi");pass=reg.test(value)}else{if(con.CTYP==="ct"){pass=value.indexOf(con.VAL)>=0}else{if(con.CTYP==="nct"){pass=value.indexOf(con.VAL)===-1}else{if(con.CTYP==="in"){var vals=con.VAL.split(";");pass=$.inArray(value,vals)>=0}else{if(con.CTYP==="nin"){var vals=con.VAL.split(";");pass=$.inArray(value,vals)===-1}else{if(con.CTYP==="gt"){if(con.DTYP==="filesize"){pass=parseInt(value)>parseFloat(con.VAL)*1024*1024}else{if(con.DTYP==="number"){pass=parseFloat(value)>parseFloat(con.VAL)}else{pass=value>con.VAL}}}else{if(con.CTYP==="gte"){if(con.DTYP==="filesize"){pass=parseInt(value)>=parseFloat(con.VAL)*1024*1024}else{if(con.DTYP==="number"){pass=parseFloat(value)>=parseFloat(con.VAL)}else{pass=value>=con.VAL}}}else{if(con.CTYP==="lt"){if(con.DTYP==="filesize"){pass=parseInt(value)<parseFloat(con.VAL)*1024*1024}else{if(con.DTYP==="number"){pass=parseFloat(value)<parseFloat(con.VAL)}else{pass=value<con.VAL}}}else{if(con.CTYP==="lte"){if(con.DTYP==="filesize"){pass=parseInt(value)<=parseFloat(con.VAL)*1024*1024}else{if(con.DTYP==="number"){pass=parseFloat(value)<=parseFloat(con.VAL)}else{pass=value=con.VAL}}}}}}}}}}}}}}if(!pass&&andor==="and"){validate=false;return false}if(pass&&andor==="or"){validate=true;return false}});return validate},execRule=function(name){$.each(RULE.FIELDSRULE||[],function(i,r){if(name){var needExe=false;$.each(r.CONS,function(j,con){if(name==con.FLD||name.indexOf(con.FLD+"_")==0){needExe=true;return false}});if(!needExe){return true}}var validate=validateConditions(r.ANDOR,r.CONS);if(!(r.RULEFLD instanceof Array)){r.RULEFLD=[r.RULEFLD]}$.each(r.RULEFLD,function(i,ruleField){if(validate){if(r.RULETYPE==="show"){$("#"+ruleField+",#au"+ruleField).removeClass("hide")}else{$("#"+ruleField+",#au"+ruleField).addClass("hide")}}else{if(r.RULETYPE==="show"){$("#"+ruleField+",#au"+ruleField).addClass("hide")}else{$("#"+ruleField+",#au"+ruleField).removeClass("hide")}}});if("goods"==$("#"+r.RULEFLD).attr("typ")){calShopCard()}});if(window.isForMobile&&window.fileUpload){fileUpload()}};if(window.RULE&&RULE.FIELDSRULE&&RULE.ENABLERULE==="1"){$.each(RULE.FIELDSRULE,function(i,r){if(r.RULETYPE==="show"){if(!(r.RULEFLD instanceof Array)){r.RULEFLD=[r.RULEFLD]}$.each(r.RULEFLD,function(i,ruleField){$("#"+ruleField).addClass("hide")})}});$(":text,input,select").change(function(){var name=$(this).attr("name");setTimeout(function(){execRule(name)})});$(":radio,:checkbox").click(function(){var name=$(this).attr("name");execRule(name)});execRule()}$("#container").removeClass("hide");var expRule=function(){if(window.RULE&&window.RULE.ENABLERULE=="1"&&RULE.EXPRESSRULE&&RULE.EXPRESSRULE.length>0){var c1=0;$.each(RULE.EXPRESSRULE,function(i,exprule){var exps=exprule.split("=");if(exps.length!=2){return true}var reg=/\$\{.+?\}/ig;var pholder,names=[];var lexprule=exps[0],rexprule=exps[1];var label=lexprule.substring(2,lexprule.indexOf("}"));$.each(FLDS,function(i,fld){if(fld.LBL==label){if(fld.TYP=="number"){names.push(fld.NM+"_number")}else{names.push(fld.NM)}return false}});while(pholder=reg.exec(rexprule)){label=pholder[0].substring(2,pholder[0].indexOf("}"));$.each(FLDS,function(i,fld){if(fld.LBL==label){if(fld.TYP=="number"){names.push(fld.NM+"_number");rexprule=rexprule.replace(pholder[0],"parseFloat($('[name="+fld.NM+"_number]', '#fields').val())")}else{names.push(fld.NM);rexprule=rexprule.replace(pholder[0],"$('[name="+fld.NM+"]', '#fields').val()")}return false}})}$.each(names,function(i,name){if(i>0){c1++;$("[name="+name+"]","#fields").bind("change",function(e){var c2=arguments[1];if(!c2){c2=1}else{c2++}if(c2>c1){$(this).unbind("change");$.alert("检测到表单设置的逻辑运算表达式存在死循环，请联系表单创建者。");return false}else{var res=eval(rexprule);if(res||res==0){$("[name="+names[0]+"]","#fields").val(res);$("[name="+names[0]+"]","#fields").trigger("change",c2)}}})}})})}};expRule();var imgs=$("#form1").find("[acmpsrcfld][acmpfld][typ='image'] img");if(imgs.length>0){for(var i=0;i<imgs.length;i++){var imgLink=$(imgs[i]).attr("src");if(typeof(imgLink)!="undefined"&&imgLink.length<50){$("#form1").find("[acmpsrcfld][acmpfld][typ='image'] img:eq("+i+")").attr("src","/rs/images/defaultimg.png")}}}}function onBridgeReady(){WeixinJSBridge.call("hideOptionMenu")}function initWeixinShare(){if(window.F&&F.DISSHARE==="1"){if(typeof WeixinJSBridge=="undefined"){if(document.addEventListener){document.addEventListener("WeixinJSBridgeReady",onBridgeReady,false)}else{if(document.attachEvent){document.attachEvent("WeixinJSBridgeReady",onBridgeReady);document.attachEvent("onWeixinJSBridgeReady",onBridgeReady)}}}else{onBridgeReady()}}}function initOthers(){$("#TMOUT").val(new Date().getTime());$("#imgKaptcha").click(function(){$(this).attr("src","/kaptcha.jpg?"+Math.floor(Math.random()*100))});if($("#needBuyInfo").length>0){$("#btnSubmit").prop("disabled",true)}$("#cornerQrcode").click(function(){var a=$("#qrcode");if(!a.attr("src")){a.attr("src","/qrcode.jpg?type=formview&c="+$("#FRMID").val())}$("#qrcodeContainer").show()});$("#qrcode").click(function(){setTimeout(function(){$("#qrcodeContainer").hide()},10)})}function initLogo(){var b=$("#container").attr("mobile");if(b){var c=$("#logo").find("a"),g=c.css("backgroundSize");if("cover"==g){var f=c.css("backgroundImage");if(f){var e=f.substring(f.indexOf("(")+1,f.lastIndexOf(")")).replace(/\"/g,"");var d=$($.format("<img src='{0}' style='border:none;width:100%;' />",e));c.append(d);d.load(function(){c.css({backgroundImage:"none",backgroundSize:"initial",height:$(this).height()})})}}}}function initImg(){if(!window.query&&!window.isForMobile){$("#fields>li").find("div.content div.goods-item img.img").live("click",function(){var a=$(this).attr("src");$.lightBox({url:"#stage",size:"l cus3",showclose:"0",loaded:function(){$("img.img-option","#stage").attr({src:a});$("img.img-option","#stage").unbind().click(function(){$.closeLightBox()})}});return false})}}function initCommitLmt(){if(typeof countLmtInfo!="undefined"&&countLmtInfo.length>0){for(var b=0;b<countLmtInfo.length;b++){var c=countLmtInfo[b];var a;if(c.TYP=="radio"){a=$("input[name='"+c.NM+"_"+c.TYP+"'][value='"+c.VAL+"']");a.parent().append("<label style='color:#ccc;'>(剩余"+c.BALANCE+")</label>")}else{if(c.TYP=="dropdown"){a=$("select[name='"+c.NM+"_"+c.TYP+"']").find("option[value='"+c.VAL+"']");a.append("<label style='color:#ccc;'>(剩余"+c.BALANCE+")</label>")}else{if(c.TYP=="checkbox"){a=$("#"+c.NM);a.parent().append("<label style='color:#ccc;'>(剩余"+c.BALANCE+")</label>")}else{if(c.TYP=="goods"){a=$("input[name='"+c.NM+"_"+c.TYP+"']");a.parents("div.text-wrapper").find("label.name").append("<label style='color:#ccc;'>(剩余"+c.BALANCE+")</label>")}}}}if(c.BALANCE==0){a.prop("disabled","disabled")}}}}function initSubFormOptAction(){if(window.isForMobile){$("li[typ='table']","#fields").find("div.tbl").addClass("hide")}$("div.rowAdd").live({click:function(){var b=$(this);if(window.isForMobile){$.lightBox({url:"#stage",size:"s",showclose:"0",btnConfirm:"#btnConfirm1, #btnConfirm2",loaded:function(){window.console.log("=======build sub table=======");$("table","#stage").remove();var k=b.prev().find("table tr:last-child");var g=$(k).clone();var c=b.prev().find("table tr:first-child");var d=$(c).clone();var l=d.find("th");var n=g.find("td");var e=$("<table style='border-collapse:separate;border-spacing:0px 10px;'>");$("#stage").prepend(e);for(var f=1;f<l.length;f++){var m=$("<tr>");$(l[f]).attr("style","");m.append(l[f]);m.append(n[f]);$(l[f]).css({"font-weight":"normal"});$(n[f]).find("fieldset.controlgroup label").css({border:"1px solid #d8e0e7"});e.append(m)}},confirm:function(){window.console.log("======= confirm =======");a(b,$("#stage").getValues());var c=$(event.target).attr("id");if("btnConfirm1"==c){$("#stage").setValues({});return false}}});return}a(b)}});function a(g,d){var e=g.prev().find("table tr:last-child");var c=$(e).siblings().length;if(c==1&&$(e).hasClass("hide")){$(e).removeClass("hide");$(e).prev().removeClass("hide");return}else{if(c>=200){$.alert("超出最大限制数，不能新增行。");return}}var f,b;if($(e).parents("div.tbl").hasClass("hide")){b=false;$(e).parents("div.tbl").removeClass("hide");f=$(e)}else{b=true;f=$(e).clone()}$.each(f.find("td"),function(n,o){if($(o).attr("typ")=="radio"){var m=$(o).find("input[type=radio]");$.each(m,function(t,k){var s=$(k).attr("name");var r=s.split("_");var q=r[0]+"_"+r[1];if(d){d[q]=d[s]}$(k).attr("name",q)})}else{if($(o).attr("typ")=="date"){var l=$(o).find(".datepincker");l.removeClass("hasDatepicker");l.attr("id",l.attr("id")+"_"+n);$(o).find("img.ui-datepicker-trigger").remove();$.initDate($(o),updateSelects)}}});$(f).setValues({},true);if(b){$(e).after(f)}refreshRadioTypeItemName(e)}$("div.tbl table tr td a.icononly-del").live({click:function(){var b=$(this).parent().parent();var c=$(b).siblings().length;if(c>1){$(b).remove()}else{$(b).addClass("hide");$(b).prev().addClass("hide")}}})}function refreshRadioTypeItemName(b){var c=$(b).parent().children();for(var a=1;a<c.length;a++){$.each($(c[a]).find("td"),function(e,f){if($(f).attr("typ")=="radio"){var d=$(f).find("input[type=radio]");$.each(d,function(m,g){var l=$(g).attr("name");var k=l.split("_");l=k[0]+"_"+k[1]+"_"+(a-1);$(g).attr("name",l)})}})}}head.ready(function(){if(isEmbed){$("body").css({background:"none",padding:"0px",margin:"0px"});$("#form1").css({marginTop:"0px"});$("#container").css({width:"100%","box-shadow":"none"}).find("#form1").css({"padding-top":"20px"});$("#logo").hide()}initYzjMenu();initFocus();initInstruct();initRadio();initNumberInput();initGoods();initMap();initAddress();initAuthCode();initValidate();initMatchAndAcmp();setDefaultValue();initRule();initDropdown2();initFieldsPermForView();initLogo();initUpload();$.initDate($("#fields"),updateSelects);initOthers();initWeixinShare();initImg();initCommitLmt();initSubFormOptAction();var a=$("#container").attr("mobile");if(a){var b=$("#container").height(),c=$(window).height()-6;if(b<c){$("#container").css({minHeight:c})}}});